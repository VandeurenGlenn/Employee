<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="..\..\bower_components/polymer/polymer.html">
<link rel="import" href="..\..\bower_components/paper-header-panel/paper-header-panel.html">
<link rel="import" href="..\..\bower_components/paper-input/paper-input.html">
<link rel="import" href="..\..\bower_components/paper-item/paper-item.html">
<link rel="import" href="..\..\bower_components/paper-checkbox/paper-checkbox.html">
<link rel="import" href="..\..\bower_components/paper-fab/paper-fab.html">
<link rel="import" href="..\..\bower_components/paper-toggle-button/paper-toggle-button.html">
<link rel="import" href="..\..\bower_components/firebase-element/firebase-auth.html">
<script src="..\..\bower_components/firebase/firebase.js"></script>

<dom-module id="create-account-section">
  <template>
    <style>
      :host {
        position: absolute;
        top: 0;
        left: 0;
        bottom: 0;
        right: 0;
        box-sizing: border-box;
        @apply(--layout-horizontal);
        @apply(--layout-center-center);
        background: #B2DFDB;
      }
      .horizontal {
        @apply(--layout-horizontal);
        @apply(--layout-center);
      }
      paper-header-panel {
        width: 100%;
      }
      .title {
        text-transform: capitalize;
      }
      iron-pages {
        position: absolute;
        top: 0;
        left: 0;
        bottom: 0;
        right: 0;
        background: #B2DFDB;
      }
      section {
        min-height: 100%;
        @apply(--layout-horizontal);
        @apply(--layout-center-center);
      }
      paper-material {
        margin: 50px;
        background: #eee;
        padding: 32px;
        min-height: 300px;
        box-sizing: border-box;
      }
      #signUp {
        @apply(--layout-vertical);
      }
      paper-input {
        text-transform: capitalize;
      }
      span.checkbox {
        @apply(--layout-horizontal);
        @apply(--layout-center);
        min-height: 48px;
      }
      paper-button {
        background: #009688;
        color: #FFFFFF;
      }
      a {
        @apply(--layout-horizontal);
        @apply(--layout-center);
        text-decoration: none;
      }
      a[disabled] {
        pointer-events: none;
      }
      .paper-font-display2 {
        margin: 16px 0;
      }
      #signUp h2 {
        margin-top: 0;
      }
      .green {
        background: green;
      }
      .red {
        background: red;
      }
      .info {
        margin-top: 0;
      }
      paper-toggle-button {
        --paper-toggle-button-unchecked-bar-color: #2196F3;
        --paper-toggle-button-unchecked-button-color: #2196F3;
        --paper-toggle-button-checked-bar-color: #E91E63;
        --paper-toggle-button-checked-button-color: #E91E63;
      }
      .paper-font-display2 {
        margin-top: 0;
      }
      .gender {
        margin: 16px 0;
      }
    </style>
    <!-- TODO: Add route bar -->
    <firebase-auth location="https://employeeio.firebaseio.com" user="{{_fbUser}}" on-error="errorHandler" status-known="{{statusKnown}}" hidden redirect></firebase-auth>
    <paper-header-panel>
      <paper-toolbar class="tall">
        <span class="middle title paper-font-display1">Account Wizard</span>
        <span class="bottom title paper-font-subhead">[[wizardRoute]]</span>
      </paper-toolbar>
      <iron-pages attr-for-selected="account-wizard-route" selected="[[wizardRoute]]">
        <section account-wizard-route="sign up method">
          <paper-material elevation="1" id="signUp">
            <h2 class="paper-font-title">Select sign up method</h2>
            <!-- TODO: gold email input ... -->
            <paper-input label="email" type="email"  auto-validate auto-complete value="[[_user.email]]"></paper-input>
            <span class="checkbox"><paper-checkbox on-tap="_setGoogleLogin" title="Login with your Google account"></paper-checkbox>Login with Google</span>
            <span class="flex"></span>
            <a href="/create-new-account" disabled$="[[_computeValidEmail(_user.email)]]">
              <span class="flex"></span>
              <paper-fab icon="check" title="Continue" disabled$="[[_computeValidEmail(_user.email)]]" on-tap="login"></paper-fab>
              <span class="flex"></span>
            </a>
          </paper-material>
        </section>
        <section account-wizard-route="create new account">
          <!-- TODO: Add desktop layout -->
          <paper-material elevation="1" id="userInfo">
            <!-- <paper-toolbar class="tall" style="width: 100%;">

            </paper-toolbar> -->
            <h2 class="paper-font-display2 info">Info</h2>
            <paper-input label="Username" auto-validate auto-complete value="{{_user.name}}"></paper-input>
            <paper-input label="email" type="email" auto-validate auto-complete value="{{_user.email}}"></paper-input>
            <paper-input label="firstname" auto-complete value="{{_user.first_name}}"></paper-input>
            <paper-input label="lastname" auto-complete value="{{_user.family_name}}"></paper-input>
            <div id="passwordInput" hidden$="[[_user.google_id]]">
              <h2 class="paper-font-display1">Password</h2>
              <paper-input label="Password" type="password"></paper-input>
              <paper-input label="Confirm Password" type="password"></paper-input>
            </div>
            <h2 class="paper-font-display1">Gender</h2>
            <span class="horizontal gender">Male<span class="flex"></span><paper-toggle-button checked$="[[computeGender(_user.gender)]]"></paper-toggle-button><span class="flex"></span>Female</span>
            <h2 class="paper-font-display1">Picture</h2>
            <!-- TODO: add alt="" -->
            <img src="[[_user.google_profile_picture]]" width="192" height="192"/></img>
            <!-- TODO: add edit function -->
            <a href="[[_user.google_plus_link]]">Google+ profile</a>
            <a href="/setup-company" class="horizontal" disabled$="[[_computeDisabled(_user)]]">
              <span class="flex"></span>
              <paper-fab icon="check" title="proceed to next step" disabled$="[[_computeDisabled(_user)]]"></paper-fab>
              <span class="flex"></span>
            </a>
          </paper-material>
        </section>
        <section account-wizard-route="add company info">
          <paper-material id="companyInfo" elevation="1">
            <h2 class="paper-font-display1 info">Info</h2>
            <paper-input label="company name" auto-complete value="{{_user.company.name}}"></paper-input>
            <paper-input label="company location" auto-complete value="{{_user.company.location}}"></paper-input>

            <a href="/setup-company" class="horizontal" disabled$="[[_computeSaveDisabled(_user.company.name, _user.company.location)]]">
              <span class="flex"></span>
              <paper-fab icon="check" title="Confirm" on-tap="_saveToFirebase" disabled$="[[_computeSaveDisabled(_user.company.name, _user.company.location)]]"></paper-fab>
              <span class="flex"></span>
            </a>
          </paper-material>
        </section>

        <section account-wizard-route="finished">
          <paper-material elevation="1">
            <span class="paper-font-display2">Succes</span>
          </paper-material>

        </section>
      </iron-pages>
    </paper-header-panel>
    <paper-toast id="paperToast" text="Your draft has been discarded."></paper-toast>
  </template>
  <script>
  (function() {
    'use strict';

    Polymer({
      is: 'create-account-section',

      properties: {
        wizardRoute: {
          type: String,
          value: 'sign up method',
          observer: 'wizardRouteChanged'
        },

        email: {
          type: String,
          observer: '_checkForDuplicateEmail',
          value: null
        },

        _fbUser: {
          type: Object,
          observer: 'syncUser'
        },

        _user: {
          type: Object,
          value: function () {
            return {
              name: null,
              first_name: null,
              family_name: null,
              gender: null,
              google_id: null,
              google_plus_link: null,
              google_profile_picture: null,
              company: {
                name: null,
                location: null,
                employees: {}
              }
            }
          }
        },

        validated: {
          type: Array,
          value: new Array()
        }
      },

      errorHandler: function (e) {
        this._showToast('Error: ' + e.detail.message);
      },

      wizardRouteChanged: function (route, oldRoute) {
        if (route === 'create-new-account') {

        } else if (oldRoute === 'create-new-account') {

        }
      },

      _setGoogleLogin: function (e) {
        var inputs = this._getInputs('signUp');
          for (var i = 0; i < inputs.length; i++) {
            if (inputs[i].label === 'email') {
              if (Polymer.dom(e).localTarget.checked) {
                if (inputs[i].value.length > 1) {
                  var tempVal = inputs[i].value;
                  inputs[i].value = tempVal.concat('@gmail.com');
                } else {
                  inputs[i].value = '@gmail.com';
                }
              } else {
                var tempVal = inputs[i].value;
                inputs[i].value = tempVal.replace('@gmail.com', '');
              }
              tempVal = null;
            }
          }

      },

      initEventListeners: function (id) {
        var inputs = this._getInputs(id);
        for (var i = 0; i < inputs.length; i++) {
          inputs[i].addEventListener('change', this._fireChange.bind(this));
        }
        // delete inputs;
      },

      _getInputs: function (id) {
        if (id) {
          return this.querySelector('#' + id).querySelectorAll('paper-input');
        }
        // return all
        return this.querySelectorAll('paper-input');
      },

      _fireChange: function (change) {
        var target = Polymer.dom(change).localTarget;
        if (target.label === 'email' && target.value.includes('@gmail.com')) {
          // show a tooltip that google login is selected
          Polymer.dom(this.querySelector('paper-checkbox')).setAttribute('checked', true);
          this.email = target.value;
        } else if (target.label === 'email' && target.value.includes('@')) {
          this.email = target.value;
           this.newUser = new Object({login: {provider: "custom"}});
           // this.newUser.login = {provider: "custom"};
           console.log(this.newUser);
        } else if (target.label === 'company name'){
          if (!this._user.company) {
            this._user.company = {};
          }
          this._user.company.name = target.value;
        } else if (target.label === 'company location'){
          if (!this._user.company) {
            this._user.company = {};
          }
          this._user.company.location = target.value;
        } else if (event.target.validity.typeMismatch) {
          this._showToast(target.label + ': ' + event.target.validationMessage);
        } else {
          this._showToast(target.label + ': saved!');
        }
      },

      _showToast: function (text) {
        this.$.paperToast.text = text;
        this.$.paperToast.show();
      },
      /**
      * Syncs the user when successfully logged in
      *
      */
      syncUser: function (user) {
        if (user) {
          this._user = {
            name: user.google.cachedUserProfile.name,
            first_name: user.google.cachedUserProfile.given_name,
            family_name: user.google.cachedUserProfile.family_name,
            gender: user.google.cachedUserProfile.gender,
            google_id: user.google.cachedUserProfile.id,
            google_plus_link: user.google.cachedUserProfile.link,
            google_profile_picture: user.google.cachedUserProfile.picture,
            email: user.google.email
          }
          this.debounce('checkDuplicate', function () {
            this._checkForDuplicateEmail(this._user.email);
            if (!this._duplicate) {
              this.wizardRoute = 'create new account';
            } else {
              this.wizardRoute = 'sign up method';
            }
          }, 1000);
        }
      },

      login: function () {
        this.querySelector('firebase-auth').params = {scope: "email"};
        this.querySelector('firebase-auth').login();
      },

      _computeSaveDisabled: function(name, location) {
        if (location && name) {
          return false;
        }
        return true;
      },

      _computeDisabled: function (user) {
        for (var info in user) {
          if (user.hasOwnProperty(info)) {
            if (user[info]) {
              return false;
            }
          }
        }
        return true;
      },

      _checkForDuplicateEmail: function (email) {
        var users = this._getRef('users');

        users.on('value', function (snap) {
          var fab = this.$.signUp.querySelector('paper-fab');
          for (var i in snap.val()) {
            if (snap.val().hasOwnProperty(i)) {
              if (snap.val()[i].email === email) {
                var p = document.createElement('p');
                p.innerHTML = 'Email already registered';
                fab.icon = 'close';
                // TODO: add unvalid email notification + pasword recovery option
                this._showToast('Email already on our servers');
                fab.title = 'email already on our servers';
                fab.classList.add('red');
                return this._duplicate = true;
              } else if (email){
                if (fab.classList.contains('red')) {
                  fab.classList.remove('red');
                  fab.icon = 'check';
                }
                fab.classList.add('green');
                this.querySelector('firebase-auth').provider = 'google';
                return this._duplicate = false;
              }
            }
          }

        }.bind(this));


      },

      _getRef: function (location) {
        return new Firebase('https://employeeio.firebaseio.com/' + location);
      },

      removeEventListeners: function () {
        var inputs = this.querySelectorAll('input');

        for (var i = 0; i < inputs.length; i++) {
          inputs[i].removeEventListener();
        }
      },

      _computeValidEmail: function (email, duplicate) {
        if (email && !duplicate) {
          return false;
        }
        return true;
      },

      computeGender: function (gender) {
        if (gender === 'male') {
          return false;
        }
        return true;
      },

      _saveToFirebase: function () {
        this.users = this._getRef('users');

        this.users.push(this._user);
      }
    });
  })();
  </script>
</dom-module>
